name: Deploy to Hostinger (live-safe)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Deploy code to Hostinger (SSH)
        uses: appleboy/ssh-action@v0.1.7
        env:
          DEPLOY_HOST: ${{ secrets.HOST }}
          DEPLOY_USER: ${{ secrets.USERNAME }}
          DEPLOY_PORT: ${{ secrets.PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          script: |
            set -euo pipefail
            echo "ðŸ”¹ Connecting to $DEPLOY_HOST..."
            cd ~/domains/smart-keyholder.click/public_html

            # Update code only, no database changes
            echo "â¬‡ï¸ Pulling latest code..."
            git fetch origin
            git checkout master
            git pull origin master

            # Install composer dependencies (production)
            if [ -x ./composer2 ]; then
              ./composer2 install --no-dev --optimize-autoloader --no-interaction
            else
              composer install --no-dev --optimize-autoloader --no-interaction || true
            fi

            # Clear Laravel caches
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan cache:clear || true
            php artisan optimize:clear || true

            # Ensure storage link exists
            php artisan storage:link || true

            # Restart queue workers if applicable
            php artisan queue:restart || true

            # Set proper permissions (best effort)
            chmod -R 755 storage bootstrap/cache public
            find storage -type f -exec chmod 644 {} \; || true

            # Optional: copy local built assets to public (if your workflow built assets)
            if [ -d public/build ]; then
              cp -r public/build/* ./build/ 2>/dev/null || true
            fi

            # Optional: verify deployment
            php artisan route:list --path=/ || echo "Route listing failed"
            echo "âœ… Code-only deployment completed. Database untouched. .env untouched."
