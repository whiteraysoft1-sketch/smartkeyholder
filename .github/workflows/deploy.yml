name: Deploy to Hostinger

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Hostinger
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd domains/smart-keyholder.click/public_html
            
            # Check if we need to create/update .env
            if [ ! -f ".env" ] || ! grep -q "u244291586_smartk" .env; then
              echo "Setting up database configuration..."
              cat > .env << 'EOL'
            APP_NAME="Smart Key Holder"
            APP_ENV=production
            APP_DEBUG=false
            APP_URL=https://smart-keyholder.click
            
            DB_CONNECTION=mysql
            DB_HOST=localhost
            DB_PORT=3306
            DB_DATABASE=u244291586_smartk
            DB_USERNAME=u244291586_smarkey
            DB_PASSWORD=KaggwaSteven@25
            
            SESSION_DRIVER=file
            SESSION_LIFETIME=120
            CACHE_DRIVER=file
            QUEUE_CONNECTION=sync
            
            MAIL_MAILER=smtp
            MAIL_HOST=smtp.hostinger.com
            MAIL_PORT=465
            MAIL_USERNAME=support@smart-keyholder.click
            MAIL_PASSWORD=Kaggwa@96
            MAIL_ENCRYPTION=ssl
            MAIL_FROM_ADDRESS=support@smart-keyholder.click
            MAIL_FROM_NAME="${APP_NAME}"
            EOL
            fi
            
            # Update code
            git fetch origin master
            git reset --hard origin/master
            
            # Update dependencies and clear cache
            composer2 install --no-dev --optimize-autoloader
            php artisan optimize:clear
            
            # Set permissions
            chmod -R 755 storage bootstrap/cache
            chmod 644 .env
            
            # Rebuild cache
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Update symlinks
            php artisan storage:link || true
            
            echo "âœ… Deployment completed!"
