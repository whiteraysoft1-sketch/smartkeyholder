name: Deploy to Hostinger (code-only, safe for live DB)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies and build assets (local)
        run: |
          npm ci
          npm run build

      - name: Deploy code to server (SSH, live-safe)
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          script: |
            set -euo pipefail
            echo "Deploy: connecting to $HOST"
            cd ~/domains/smart-keyholder.click/public_html

            # Update only code (no DB changes)
            git fetch origin
            git checkout master
            git pull origin master

            # Composer install (no dev, optimized)
            if [ -x ./composer2 ]; then
              ./composer2 install --no-dev --optimize-autoloader --no-interaction
            else
              composer install --no-dev --optimize-autoloader --no-interaction || true
            fi

            # Laravel caches and optimization
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan cache:clear || true
            php artisan optimize:clear || true

            # Ensure storage link exists
            php artisan storage:link || true

            # Restart queue workers if applicable
            php artisan queue:restart || true

            # Permissions (best-effort)
            chmod -R 775 storage bootstrap/cache || true
            find storage -type f -exec chmod 664 {} \; || true

            echo "âœ… Code deployment completed. Database untouched. .env untouched."
